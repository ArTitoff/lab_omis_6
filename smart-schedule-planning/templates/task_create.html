<!-- templates/task_create.html -->
{% extends "base.html" %}

{% block title %}Создать задачу{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1>Создать задачу</h1>
        <p class="page-subtitle">Добавьте новую задачу с указанием времени</p>
    </div>
    
    <div class="card">
        <div class="card-body">
            <form method="POST" action="{{ url_for('task.create_task') }}" class="task-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="title" class="form-label">Название задачи *</label>
                        <input type="text" id="title" name="title" class="form-input" 
                               placeholder="Например: Подготовить презентацию" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="priority" class="form-label">Приоритет</label>
                        <select id="priority" name="priority" class="form-input">
                            <option value="низкий">Низкий</option>
                            <option value="средний" selected>Средний</option>
                            <option value="высокий">Высокий</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="description" class="form-label">Описание</label>
                    <textarea id="description" name="description" class="form-input" 
                              rows="3" placeholder="Детали задачи..."></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="deadline_date" class="form-label">Дата выполнения *</label>
                        <input type="date" id="deadline_date" name="deadline_date" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="deadline_time" class="form-label">Время начала *</label>
                        <input type="time" id="deadline_time" name="deadline_time" class="form-input" value="14:00" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="duration" class="form-label">Продолжительность (минуты)</label>
                    <div class="input-with-button">
                        <input type="number" id="duration" name="duration" class="form-input" 
                               value="60" min="15" step="15" required>
                        <button type="button" id="suggest-time-btn" class="btn btn-primary">
                            <i class="fas fa-clock"></i> Подобрать оптимальное время
                        </button>
                    </div>
                </div>
                
                <!-- Контейнер для предложений времени -->
                <div id="time-suggestions" class="suggestions-container" style="display: none;">
                    <h4>Предложенные временные слоты:</h4>
                    <div id="suggestions-list"></div>
                </div>
                
                <!-- Отображение выбранного времени -->
                <div id="selected-time-display" class="selected-time-display" style="display: none;">
                    <h4>Выбранное время:</h4>
                    <div class="selected-time-info">
                        <strong>Дата:</strong> <span id="selected-date">-</span><br>
                        <strong>Время начала:</strong> <span id="selected-start-time">-</span><br>
                        <strong>Продолжительность:</strong> <span id="selected-duration">-</span> минут
                    </div>
                </div>
                
                {% if schedules %}
                <div class="form-group">
                    <label for="schedule_id" class="form-label">Добавить в расписание (опционально)</label>
                    <select id="schedule_id" name="schedule_id" class="form-input">
                        <option value="">Не добавлять в расписание</option>
                        {% for schedule in schedules %}
                        <option value="{{ schedule.id }}">{{ schedule.title }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                
                <div class="form-actions">
                    <a href="{{ url_for('task.task_list') }}" class="btn btn-outline">
                        Отмена
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Создать задачу
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Устанавливаем минимальную дату - сегодня
    const today = new Date().toISOString().split('T')[0];
    const deadlineDateInput = document.getElementById('deadline_date');
    if (deadlineDateInput) {
        deadlineDateInput.min = today;
        
        // Если пусто, устанавливаем дату через 3 дня по умолчанию
        if (!deadlineDateInput.value) {
            const threeDaysLater = new Date();
            threeDaysLater.setDate(threeDaysLater.getDate() + 3);
            deadlineDateInput.value = threeDaysLater.toISOString().split('T')[0];
        }
    }
    
    // Элементы для отображения выбранного времени
    const selectedTimeDisplay = document.getElementById('selected-time-display');
    const selectedDateSpan = document.getElementById('selected-date');
    const selectedStartTimeSpan = document.getElementById('selected-start-time');
    const selectedDurationSpan = document.getElementById('selected-duration');
    
    // Функция для обновления отображения выбранного времени
    function updateSelectedTimeDisplay(date, startTime, duration) {
        selectedDateSpan.textContent = date;
        selectedStartTimeSpan.textContent = startTime;
        selectedDurationSpan.textContent = duration;
        selectedTimeDisplay.style.display = 'block';
        
        // Анимированное появление
        selectedTimeDisplay.style.animation = 'slideIn 0.3s ease-out';
    }
    
    // Функция для форматирования даты
    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    }
    
    // Обработчик кнопки "Подобрать время"
    const suggestBtn = document.getElementById('suggest-time-btn');
    
    if (suggestBtn) {
        suggestBtn.addEventListener('click', function() {
            const durationInput = document.getElementById('duration');
            const prioritySelect = document.getElementById('priority');
            const duration = parseInt(durationInput.value) || 60;
            const priority = prioritySelect.value;
            
            if (duration < 15) {
                alert('Продолжительность должна быть не менее 15 минут');
                return;
            }
            
            // Показываем загрузку
            const originalHTML = suggestBtn.innerHTML;
            suggestBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ищем время...';
            suggestBtn.disabled = true;
            
            // Отправляем запрос на сервер
            fetch('/tasks/suggest-time', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    duration: duration,
                    priority: priority
                })
            })
            .then(response => response.json())
            .then(data => {
                const suggestionsContainer = document.getElementById('time-suggestions');
                const suggestionsList = document.getElementById('suggestions-list');
                
                if (data.success && data.suggestions && data.suggestions.length > 0) {
                    // Показываем предложения
                    suggestionsContainer.style.display = 'block';
                    suggestionsList.innerHTML = '';
                    
                    data.suggestions.forEach((suggestion, index) => {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.className = 'suggestion-item';
                        suggestionItem.innerHTML = `
                            <div class="suggestion-header">
                                <div class="suggestion-time">
                                    <strong>${suggestion.date} ${suggestion.start_time} - ${suggestion.end_time}</strong>
                                    <span class="suggestion-score">${suggestion.score || 0}%</span>
                                </div>
                                <button type="button" class="btn-select-suggestion btn btn-sm btn-primary">
                                    Выбрать
                                </button>
                            </div>
                            <div class="suggestion-reason">
                                ${suggestion.reason || 'Рекомендуемое время'}
                            </div>
                            <div class="suggestion-duration">
                                Продолжительность: ${suggestion.duration} минут
                            </div>
                        `;
                        
                        // Кнопка выбора времени
                        const selectBtn = suggestionItem.querySelector('.btn-select-suggestion');
                        selectBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            
                            // Заполняем поля формы
                            document.getElementById('deadline_date').value = suggestion.date;
                            document.getElementById('deadline_time').value = suggestion.start_time;
                            document.getElementById('duration').value = suggestion.duration;
                            
                            // Обновляем отображение выбранного времени
                            updateSelectedTimeDisplay(
                                formatDate(suggestion.date),
                                suggestion.start_time,
                                suggestion.duration
                            );
                            
                            // Показываем уведомление
                            showNotification(`Выбрано время: ${suggestion.date} ${suggestion.start_time} (${suggestion.duration} минут)`);
                            
                            // Выделяем выбранное предложение
                            document.querySelectorAll('.suggestion-item').forEach(item => {
                                item.classList.remove('selected');
                            });
                            suggestionItem.classList.add('selected');
                        });
                        
                        // Также можно выбрать при клике на весь элемент
                        suggestionItem.addEventListener('click', function(e) {
                            if (!e.target.classList.contains('btn-select-suggestion')) {
                                // Заполняем поля формы
                                document.getElementById('deadline_date').value = suggestion.date;
                                document.getElementById('deadline_time').value = suggestion.start_time;
                                document.getElementById('duration').value = suggestion.duration;
                                
                                // Обновляем отображение выбранного времени
                                updateSelectedTimeDisplay(
                                    formatDate(suggestion.date),
                                    suggestion.start_time,
                                    suggestion.duration
                                );
                                
                                // Показываем уведомление
                                showNotification(`Выбрано время: ${suggestion.date} ${suggestion.start_time}`);
                                
                                // Выделяем выбранное предложение
                                document.querySelectorAll('.suggestion-item').forEach(item => {
                                    item.classList.remove('selected');
                                });
                                suggestionItem.classList.add('selected');
                            }
                        });
                        
                        suggestionsList.appendChild(suggestionItem);
                    });
                } else {
                    alert(data.error || 'Не найдено подходящего времени');
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Ошибка при поиске времени');
            })
            .finally(() => {
                // Восстанавливаем кнопку
                suggestBtn.innerHTML = originalHTML;
                suggestBtn.disabled = false;
            });
        });
    }
    
    // Функция для показа уведомлений
    function showNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.innerHTML = `
            <i class="fas fa-check-circle"></i> ${message}
            <button class="notification-close">&times;</button>
        `;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 10px;
        `;
        
        notification.querySelector('.notification-close').onclick = () => notification.remove();
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }
    
    // Добавляем стили для анимации
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            margin-left: 10px;
        }
        
        /* Стили для предложений времени */
        .suggestions-container {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .suggestion-item {
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .suggestion-item:hover {
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .suggestion-item.selected {
            border-color: #28a745;
            background: #f0fff4;
        }
        
        .suggestion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .suggestion-time {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .suggestion-score {
            background: #ffc107;
            color: #212529;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .suggestion-reason {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .suggestion-duration {
            color: #495057;
            font-size: 0.9em;
        }
        
        /* Стили для отображения выбранного времени */
        .selected-time-display {
            margin-top: 20px;
            padding: 15px;
            background: #e7f5ff;
            border-radius: 8px;
            border: 2px solid #007bff;
        }
        
        .selected-time-info {
            padding: 10px;
            background: white;
            border-radius: 6px;
            margin-top: 10px;
        }
        
        .selected-time-info strong {
            color: #495057;
        }
        
        /* Стили для кнопки выбора */
        .btn-select-suggestion {
            padding: 3px 10px;
            font-size: 0.8em;
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}