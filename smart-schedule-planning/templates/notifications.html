<!-- templates/notifications.html -->
{% extends "base.html" %}

{% block title %}Уведомления{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1>Уведомления</h1>
        <p class="page-subtitle">Напоминания о задачах и событиях</p>
    </div>
    
    <div class="notifications-container">
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-bell"></i> Мои уведомления</h3>
                <div class="header-actions">
                    <button id="mark-all-read" class="btn btn-sm btn-outline">
                        <i class="fas fa-check-double"></i> Прочитать все
                    </button>
                    <button id="refresh-notifications" class="btn btn-sm btn-outline">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="notifications-tabs">
                    <button class="tab-btn active" data-tab="all">Все</button>
                    <button class="tab-btn" data-tab="unread">Непрочитанные</button>
                    <button class="tab-btn" data-tab="tasks">Задачи</button>
                    <button class="tab-btn" data-tab="deadlines">Дедлайны</button>
                </div>
                
                <div id="notifications-list" class="notifications-list">
                    <div class="loading-notifications">
                        <i class="fas fa-spinner fa-spin"></i> Загрузка уведомлений...
                    </div>
                </div>
                
                <div id="empty-notifications" class="empty-state" style="display: none;">
                    <i class="fas fa-bell-slash fa-3x"></i>
                    <h4>Нет уведомлений</h4>
                    <p>Здесь будут появляться напоминания о ваших задачах</p>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-cog"></i> Настройки уведомлений</h3>
            </div>
            <div class="card-body">
                <div class="notification-settings">
                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Напоминания о задачах</h5>
                            <p>Уведомлять о начале задач за:</p>
                        </div>
                        <div class="setting-control">
                            <select class="form-input form-input-sm">
                                <option>15 минут</option>
                                <option selected>30 минут</option>
                                <option>1 час</option>
                                <option>2 часа</option>
                                <option>Не уведомлять</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Напоминания о дедлайнах</h5>
                            <p>Уведомлять о дедлайнах за:</p>
                        </div>
                        <div class="setting-control">
                            <select class="form-input form-input-sm">
                                <option>1 день</option>
                                <option selected>2 дня</option>
                                <option>3 дня</option>
                                <option>Неделя</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Ежедневный дайджест</h5>
                            <p>Отправлять сводку на день</p>
                        </div>
                        <div class="setting-control">
                            <label class="switch">
                                <input type="checkbox" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h5>Уведомления по email</h5>
                            <p>Отправлять копии на email</p>
                        </div>
                        <div class="setting-control">
                            <label class="switch">
                                <input type="checkbox">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary btn-block mt-4">
                    <i class="fas fa-save"></i> Сохранить настройки
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentTab = 'all';
    let notifications = [];
    
    // Загрузить уведомления
    function loadNotifications() {
        const list = document.getElementById('notifications-list');
        const empty = document.getElementById('empty-notifications');
        
        list.innerHTML = '<div class="loading-notifications"><i class="fas fa-spinner fa-spin"></i> Загрузка...</div>';
        empty.style.display = 'none';
        
        // Здесь будет реальный запрос к API
        // fetch('/api/notifications')
        
        // Для демо - имитируем задержку
        setTimeout(() => {
            // Тестовые данные
            notifications = [
                {
                    id: 1,
                    text: 'Задача "Подготовить отчет" начинается через 30 минут',
                    type: 'task_reminder',
                    time: '10:30',
                    date: 'Сегодня',
                    isRead: false,
                    taskId: 101
                },
                {
                    id: 2,
                    text: 'Дедлайн задачи "Сделать презентацию" через 2 дня',
                    type: 'deadline',
                    time: '09:15',
                    date: 'Вчера',
                    isRead: true,
                    taskId: 102
                },
                {
                    id: 3,
                    text: 'Встреча "Совещание по проекту" запланирована на 14:00',
                    type: 'meeting',
                    time: '14:00',
                    date: 'Сегодня',
                    isRead: false,
                    taskId: null
                },
                {
                    id: 4,
                    text: 'Задача "Написать код" выполнена',
                    type: 'completed',
                    time: '16:45',
                    date: '12 дек',
                    isRead: true,
                    taskId: 103
                }
            ];
            
            renderNotifications();
        }, 500);
    }
    
    // Отобразить уведомления
    function renderNotifications() {
        const list = document.getElementById('notifications-list');
        const empty = document.getElementById('empty-notifications');
        
        // Фильтрация по вкладке
        let filtered = notifications;
        
        if (currentTab === 'unread') {
            filtered = notifications.filter(n => !n.isRead);
        } else if (currentTab === 'tasks') {
            filtered = notifications.filter(n => n.type === 'task_reminder' || n.type === 'deadline');
        } else if (currentTab === 'deadlines') {
            filtered = notifications.filter(n => n.type === 'deadline');
        }
        
        if (filtered.length === 0) {
            list.innerHTML = '';
            empty.style.display = 'block';
            return;
        }
        
        let html = '';
        filtered.forEach(notification => {
            const icon = getNotificationIcon(notification.type);
            const typeClass = getNotificationTypeClass(notification.type);
            
            html += `
                <div class="notification-item ${notification.isRead ? 'read' : 'unread'}" 
                     data-id="${notification.id}">
                    <div class="notification-icon ${typeClass}">
                        <i class="${icon}"></i>
                    </div>
                    <div class="notification-content">
                        <p class="notification-text">${notification.text}</p>
                        <div class="notification-meta">
                            <span class="notification-time">${notification.time}</span>
                            <span class="notification-date">${notification.date}</span>
                            ${!notification.isRead ? '<span class="badge badge-new">НОВОЕ</span>' : ''}
                        </div>
                    </div>
                    <div class="notification-actions">
                        ${notification.taskId ? `
                            <button class="btn-action" onclick="viewTask(${notification.taskId})" 
                                    title="Перейти к задаче">
                                <i class="fas fa-external-link-alt"></i>
                            </button>
                        ` : ''}
                        ${!notification.isRead ? `
                            <button class="btn-action mark-read" 
                                    onclick="markAsRead(${notification.id})" 
                                    title="Пометить прочитанным">
                                <i class="fas fa-check"></i>
                            </button>
                        ` : ''}
                        <button class="btn-action delete-notification" 
                                onclick="deleteNotification(${notification.id})" 
                                title="Удалить">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        
        list.innerHTML = html;
        empty.style.display = 'none';
    }
    
    // Получить иконку для типа уведомления
    function getNotificationIcon(type) {
        switch(type) {
            case 'task_reminder': return 'fas fa-tasks';
            case 'deadline': return 'fas fa-clock';
            case 'meeting': return 'fas fa-users';
            case 'completed': return 'fas fa-check-circle';
            default: return 'fas fa-bell';
        }
    }
    
    // Получить класс для типа уведомления
    function getNotificationTypeClass(type) {
        switch(type) {
            case 'task_reminder': return 'type-task';
            case 'deadline': return 'type-deadline';
            case 'meeting': return 'type-meeting';
            case 'completed': return 'type-completed';
            default: return 'type-default';
        }
    }
    
    // Переключение вкладок
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Убрать активный класс у всех кнопок
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            // Добавить активный класс текущей кнопке
            this.classList.add('active');
            // Обновить текущую вкладку
            currentTab = this.dataset.tab;
            // Перерисовать уведомления
            renderNotifications();
        });
    });
    
    // Пометить все как прочитанные
    document.getElementById('mark-all-read').addEventListener('click', function() {
        notifications.forEach(n => n.isRead = true);
        renderNotifications();
        showToast('Все уведомления помечены как прочитанные');
    });
    
    // Обновить уведомления
    document.getElementById('refresh-notifications').addEventListener('click', loadNotifications);
    
    // Функции для работы с уведомлениями (имитация)
    window.markAsRead = function(id) {
        const notification = notifications.find(n => n.id === id);
        if (notification) {
            notification.isRead = true;
            renderNotifications();
            showToast('Уведомление помечено как прочитанное');
        }
    };
    
    window.deleteNotification = function(id) {
        if (confirm('Удалить уведомление?')) {
            notifications = notifications.filter(n => n.id !== id);
            renderNotifications();
            showToast('Уведомление удалено');
        }
    };
    
    window.viewTask = function(taskId) {
        window.location.href = `/tasks/${taskId}`;
    };
    
    // Вспомогательная функция для сообщений
    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }
    
    // Инициализация
    loadNotifications();
});
</script>

<style>
.notifications-container {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    margin-top: 20px;
}

.header-actions {
    display: flex;
    gap: 10px;
}

.notifications-tabs {
    display: flex;
    gap: 5px;
    margin-bottom: 20px;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 10px;
}

.tab-btn {
    padding: 8px 15px;
    background: none;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    color: #6c757d;
    font-size: 14px;
    transition: all 0.2s;
}

.tab-btn:hover {
    background: #f8f9fa;
    color: #495057;
}

.tab-btn.active {
    background: #007bff;
    color: white;
}

.notifications-list {
    max-height: 500px;
    overflow-y: auto;
}

.notification-item {
    display: flex;
    align-items: flex-start;
    padding: 15px;
    border-bottom: 1px solid #f0f0f0;
    transition: background 0.2s;
}

.notification-item:hover {
    background: #f8f9fa;
}

.notification-item.unread {
    background: #f0f7ff;
    border-left: 3px solid #007bff;
}

.notification-item.read {
    opacity: 0.8;
}

.notification-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    flex-shrink: 0;
}

.notification-icon.type-task { background: #e3f2fd; color: #1976d2; }
.notification-icon.type-deadline { background: #ffebee; color: #d32f2f; }
.notification-icon.type-meeting { background: #e8f5e9; color: #388e3c; }
.notification-icon.type-completed { background: #fff3e0; color: #f57c00; }
.notification-icon.type-default { background: #f5f5f5; color: #616161; }

.notification-content {
    flex: 1;
}

.notification-text {
    margin: 0 0 5px 0;
    color: #333;
    line-height: 1.4;
}

.notification-meta {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.85em;
    color: #6c757d;
}

.notification-time {
    font-weight: 500;
}

.badge-new {
    background: #dc3545;
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 0.7em;
    font-weight: bold;
}

.notification-actions {
    display: flex;
    gap: 5px;
    opacity: 0;
    transition: opacity 0.2s;
}

.notification-item:hover .notification-actions {
    opacity: 1;
}

.btn-action {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    border: none;
    background: #f8f9fa;
    color: #6c757d;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.btn-action:hover {
    background: #007bff;
    color: white;
}

.notification-settings {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 0;
    border-bottom: 1px solid #f0f0f0;
}

.setting-item:last-child {
    border-bottom: none;
}

.setting-info h5 {
    margin: 0 0 5px 0;
    color: #333;
}

.setting-info p {
    margin: 0;
    color: #666;
    font-size: 0.9em;
}

.setting-control {
    display: flex;
    align-items: center;
    gap: 10px;
}

.form-input-sm {
    padding: 5px 10px;
    font-size: 14px;
    min-width: 150px;
}

.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 24px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: #007bff;
}

input:checked + .slider:before {
    transform: translateX(26px);
}

.loading-notifications {
    text-align: center;
    padding: 40px;
    color: #6c757d;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #6c757d;
}

.empty-state i {
    font-size: 3em;
    color: #adb5bd;
    margin-bottom: 15px;
    display: block;
}

.empty-state h4 {
    margin: 10px 0;
    color: #495057;
}

.toast-notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #333;
    color: white;
    padding: 15px 20px;
    border-radius: 5px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s;
    z-index: 1000;
}

.toast-notification.show {
    opacity: 1;
    transform: translateY(0);
}
</style>
{% endblock %}